<!DOCTYPE html><html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­è¨€å­¦ä¹ åŠ©æ‰‹ | è¯­éŸ³è¯„åˆ†ä¸è¯­æ³•æ£€æµ‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/static/test_api.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Noto Sans', system-ui, sans-serif;
            background-color: #E9F1FF;
            color: #212529;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .app-container {
            width: 1440px;
            min-height: 800px;
            padding: 32px;
            display: flex;
            flex-direction: column;
        }
        
        .content-card {
            background: #FFFFFF;
            border: 1px solid #E9ECEF;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px -4px rgba(0,0,0,0.04);
            overflow: hidden;
            flex: 1;
            padding: 32px;
        }
        
        header.navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 32px 0;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .tabs {
            display: flex;
            background: #F1F3F5;
            border-radius: 6px;
            padding: 4px;
        }
        
        .tab-btn {
            padding: 10px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #495057;
        }
        
        .tab-btn.active {
            background: #FFFFFF;
            color: #3A86FF;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        
        .module {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .module.active {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 32px;
            height: 100%;
        }
        
        .panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
            height: 100%;
        }
        
        h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 8px;
        }
        
        .description {
            color: #868E96;
            margin-bottom: 20px;
        }
        
        .sentence-box {
            background: #F8F9FA;
            padding: 24px;
            border-radius: 8px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .dashboard {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .score-display {
            font-size: 5rem;
            font-weight: 800;
            margin: 24px 0;
            transition: color 0.4s;
        }
        
        .score-rating {
            font-size: 1.4rem;
            font-weight: 600;
            color: #FB8500;
        }
        
        .chart-container {
            width: 100%;
            height: 180px;
        }
        
        .recorder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        
        .rec-btn {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #3A86FF;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.5);
        }
        
        .rec-btn:hover {
            background: #2B6BC8;
        }
        
        .recording .rec-btn {
            animation: pulse 1.5s infinite;
        }
        
        .timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
        }
        
        input, textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid #DEE2E6;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .error-text {
            background: #FFF5F5;
            padding: 24px;
            border-radius: 8px;
            position: relative;
        }
        
        .highlight {
            background: rgba(230, 57, 70, 0.12);
            color: #E63946;
            border-bottom: 2px dashed #E63946;
        }
        
        .upload-area {
            border: 2px dashed #DEE2E6;
            border-radius: 8px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-area:hover {
            border-color: #3A86FF;
        }
        
        .upload-icon {
            background: #F1F3F5;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            color: #3A86FF;
        }
        
        .file-desc {
            color: #868E96;
            margin-bottom: 16px;
        }
        
        footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 0 0 0;
            color: #868E96;
            border-top: 1px solid #E9ECEF;
            margin-top: 32px;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .progress-bar {
            width: 160px;
            height: 6px;
            background: #E9ECEF;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3A86FF;
            width: 65%;
        }
        
        .setting-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.5); }
            70% { box-shadow: 0 0 0 12px rgba(58, 134, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .mode-selector {
            display: flex;
            background: #F1F3F5;
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 24px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .mode-btn.active {
            background: #FFFFFF;
            color: #3A86FF;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="navbar">
            <div class="brand">
                <iconify-icon icon="carbon:language" width="32" height="32"></iconify-icon>
                <span>æ„Ÿè§‰å·®ç‚¹ä»€ä¹ˆçš„è¯­å­¦åŠ©æ‰‹</span>
            </div>
            <div class="tabs">
                <div class="tab-btn active" data-target="speech">è‹±è¯­è¯­éŸ³è¯„åˆ†</div>
                <div class="tab-btn" data-target="grammar">è‹±æ–‡è¯­æ³•æ£€æµ‹</div>
                <div class="tab-btn" data-target="custom">è‡ªå®šä¹‰ç»ƒä¹ </div>
            </div>
        </header>
        
        <main class="content-card">
            <!-- è¯­éŸ³è¯„åˆ†æ¨¡å— -->
            <div id="speech" class="module active">
                <div class="panel">
                    <div>
                        <h2>è‹±è¯­å‘éŸ³è¯„åˆ†</h2>
                        <p class="description">æœ—è¯»ä»¥ä¸‹è‹±è¯­å¥å­ï¼Œç³»ç»Ÿå°†è¯„ä¼°æ‚¨çš„å‘éŸ³å‡†ç¡®åº¦å¹¶ç»™å‡ºæ”¹è¿›å»ºè®®</p>
                        <div class="sentence-box">
                            The pursuit of knowledge and innovation drives human progress.
                        </div>
                        <button class="generate-sentence-btn" style="background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px; display: flex; align-items: center; gap: 8px;">
                            <iconify-icon icon="mdi:refresh" width="20" height="20"></iconify-icon>
                            <span>ç”Ÿæˆæ–°å¥å­</span>
                        </button>
                    </div>
                    
                    <div class="recorder">
                        <div>
                            <p class="timer">00:00</p>
                            <button class="rec-btn">
                                <iconify-icon icon="mdi:microphone" width="32" height="32"></iconify-icon>
                            </button>
                        </div>
                        <div class="chart-container" id="waveform"></div>
                        
                        <!-- æ·»åŠ è¯„åˆ†æ¨¡å¼åˆ‡æ¢ -->
                        <div style="margin-top: 16px; text-align: center;">
                            <label style="display: flex; align-items: center; gap: 8px; justify-content: center; cursor: pointer; margin-bottom: 8px;">
                                <input type="checkbox" id="useSimpleScoring" style="width: auto;">
                                <span style="font-size: 0.9rem; color: #495057;">ä½¿ç”¨ç®€åŒ–è¯„åˆ†æ¨¡å¼</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; justify-content: center; cursor: pointer;">
                                <input type="checkbox" id="useDetailedScoring" style="width: auto;">
                                <span style="font-size: 0.9rem; color: #495057;">å¯ç”¨å®Œæ•´æ¨¡å¼è¯¦ç»†åˆ†æ</span>
                            </label>
                            <p style="font-size: 0.8rem; color: #868E96; margin-top: 4px;">
                                ç®€åŒ–æ¨¡å¼æ›´ç¨³å®šï¼Œå®Œæ•´æ¨¡å¼æä¾›è¯¦ç»†çš„å‘éŸ³æ”¹è¿›å»ºè®®
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard">
                    <h2>æˆç»©åˆ†æ</h2>
                    <div class="score-display" style="color: #3A86FF">0</div>
                    <div class="score-rating">æœªè¯„åˆ†</div>
                    
                    <div class="chart-container" id="score-dashboard"></div>
                    
                    <div style="margin-top: 24px; text-align: center;">
                        <p style="margin-bottom: 12px; color: #495057">å‘éŸ³æ”¹å–„å»ºè®®:</p>
                    </div>
                </div>
            </div>
            
            <!-- è¯­æ³•æ£€æµ‹æ¨¡å— -->
            <div id="grammar" class="module">
                <div class="panel">
                    <div>
                        <h2>è‹±æ–‡è¯­æ³•æ£€æµ‹</h2>
                        <p class="description">è¾“å…¥è‹±æ–‡æ–‡æœ¬ï¼Œç³»ç»Ÿå°†æ£€æµ‹è¯­æ³•é”™è¯¯å¹¶æä¾›ä¿®æ”¹å»ºè®®</p>
                        <div class="sentence-box">
                            I have went to the store yesterday and buyed some groceries.
                        </div>
                        <button class="generate-sentence-btn" style="background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px; display: flex; align-items: center; gap: 8px;">
                            <iconify-icon icon="mdi:refresh" width="20" height="20"></iconify-icon>
                            <span>ç”Ÿæˆæ–°å¥å­</span>
                        </button>
                    </div>
                    
                    <div>
                        <textarea rows="6" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„è‹±æ–‡æ–‡æœ¬...">I have went to the store yesterday and buyed some groceries.</textarea>
                        <button class="rec-btn" style="margin-top: 16px;">
                            <iconify-icon icon="mdi:microphone" width="24" height="24"></iconify-icon>
                        </button>
                    </div>
                </div>
                
                <div class="panel" style="height: 100%;">
                    <h2>è¯­æ³•åˆ†æ</h2>
                    <div class="error-text">
                        <p>I have <span class="highlight">went</span> to the store yesterday and <span class="highlight">buyed</span> some groceries.</p>
                        <p style="margin-top: 24px;">ä¿®æ”¹å»ºè®®:</p>
                        <p style="margin-top: 8px;">1. "went" åº”ä¸º "gone"ï¼ˆ"have" ååº”ä½¿ç”¨è¿‡å»åˆ†è¯ï¼‰</p>
                        <p>2. "buyed" ä¸ºé”™è¯¯å½¢å¼ï¼Œæ­£ç¡®çš„è¿‡å»å¼æ˜¯ "bought"</p>
                        <p>æ­£ç¡®å½¢å¼: <strong>I have gone to the store yesterday and bought some groceries.</strong></p>
                    </div>
                </div>
            </div>
            
            <!-- è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å— -->
            <div id="custom" class="module">
                <div class="panel">
                    <div>
                        <h2>è‡ªå®šä¹‰ç»ƒä¹ </h2>
                        <p class="description">ä¸Šä¼ ç»ƒä¹ ææ–™ï¼Œåˆ›å»ºä¸ªæ€§åŒ–å­¦ä¹ å†…å®¹</p>
                        
                        <div class="mode-selector">
                            <div class="mode-btn active">éŸ³é¢‘ç»ƒä¹ </div>
                            <div class="mode-btn">æ–‡æœ¬ç»ƒä¹ </div>
                        </div>
                        
                        <div class="upload-area">
                            <div class="upload-icon">
                                <iconify-icon icon="mdi-cloud-upload" width="32" height="32"></iconify-icon>
                            </div>
                            <h3>æ‹–æ”¾éŸ³é¢‘æ–‡ä»¶è‡³æ­¤å¤„</h3>
                            <p class="file-desc">æ”¯æŒ MP3ã€WAV æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 50MB</p>
                            <button style="background: #3A86FF; color: white; padding: 10px 24px; border-radius: 6px; border: none; cursor: pointer;">
                                é€‰æ‹©æ–‡ä»¶
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: auto;">
                        <p style="margin-bottom: 16px; color: #495057">å·²ä¸Šä¼ æ–‡ä»¶:</p>
                        <div style="display: flex; gap: 12px; align-items: center; padding: 12px; border: 1px solid #E9ECEF; border-radius: 6px;">
                            <iconify-icon icon="mdi:file-music" width="24" height="24" style="color: #3A86FF;"></iconify-icon>
                            <div>
                                <p style="font-weight: 500;">custom_practice.mp3</p>
                                <p style="color: #868E96; font-size: 0.875rem;">12.5 MB â€¢ ä¸Šä¼ äº 10åˆ†é’Ÿå‰</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div style="height: 100%; display: flex; flex-direction: column;">
                        <h2>ç»ƒä¹ æ§åˆ¶é¢æ¿</h2>
                        <div class="sentence-box" style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                            <p>è‡ªå®šä¹‰ç»ƒä¹ å†…å®¹å°†åœ¨æ­¤å¤„æ˜¾ç¤º...</p>
                        </div>
                        
                        <div style="margin-top: auto; display: flex; gap: 16px; justify-content: center;">
                            <button style="background: #E9F1FF; color: #3A86FF; padding: 12px 24px; border-radius: 6px; border: 1px solid #3A86FF; cursor: pointer;">
                                å¼€å§‹ç»ƒä¹ 
                            </button>
                            <button style="background: #3A86FF; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer;">
                                æäº¤ç­”æ¡ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <div class="setting-btn">
                <iconify-icon icon="mdi:cog" width="20" height="20"></iconify-icon>
                <span>ç³»ç»Ÿè®¾ç½®</span>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åˆ‡æ¢é€‰é¡¹å¡
            const tabBtns = document.querySelectorAll('.tab-btn');
            const modules = document.querySelectorAll('.module');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                    tabBtns.forEach(b => b.classList.remove('active'));
                    modules.forEach(m => m.classList.remove('active'));

                    // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                    btn.classList.add('active');
                    const targetModule = document.getElementById(btn.dataset.target);
                    if (targetModule) {
                        targetModule.classList.add('active');
                    }
                });
            });

            // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªé€‰é¡¹å¡
            if (tabBtns.length > 0) {
                tabBtns[0].click();
            }

            // åˆå§‹åŒ–æ³¢å½¢å›¾
            function initWaveform() {
                const chartDom = document.getElementById('waveform');
                if (!chartDom) return;
                
                const myChart = echarts.init(chartDom);
                
                // ç”Ÿæˆæ¨¡æ‹Ÿå½•éŸ³æ³¢å½¢æ•°æ®
                const data = Array.from({length: 200}, () => Math.random() * 50);
                
                const option = {
                    grid: {
                        top: 10,
                        bottom: 10,
                        left: 0,
                        right: 0
                    },
                    xAxis: {
                        type: 'category',
                        show: false
                    },
                    yAxis: {
                        type: 'value',
                        show: false
                    },
                    series: [
                        {
                            name: 'éŸ³é¢‘æ³¢å½¢',
                            type: 'line',
                            showSymbol: false,
                            data: data,
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [
                                        {offset: 0, color: 'rgba(58, 134, 255, 0.3)'},
                                        {offset: 1, color: 'rgba(58, 134, 255, 0.05)'}
                                    ]
                                }
                            },
                            lineStyle: {
                                width: 1.5,
                                color: '#3A86FF'
                            }
                        }
                    ]
                };
                
                myChart.setOption(option);
            }

            // åˆå§‹åŒ–è¯„åˆ†ä»ªè¡¨ç›˜ï¼Œå¹¶æš´éœ²å¯æ›´æ–°çš„å‡½æ•°
            let scoreChart = null;
            function initDashboard() {
                const chartDom = document.getElementById('score-dashboard');
                if (!chartDom) return;
                scoreChart = echarts.init(chartDom);

                const option = {
                    tooltip: { formatter: '{a} : {c}' },
                    series: [{
                        name: 'å‘éŸ³è¯„åˆ†',
                        type: 'gauge',
                        startAngle: 180,
                        endAngle: 0,
                        min: 0,
                        max: 100,
                        radius: '100%',
                        center: ['50%', '60%'],
                        splitNumber: 10,
                        axisLine: { lineStyle: { width: 10, color: [[0.6,'#FFD166'],[0.8,'#3A86FF'],[1,'#52B788']] } },
                        pointer: { icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z', length: '12%', width: 10, offsetCenter: [0,'-60%'], itemStyle: { color: '#495057' } },
                        axisTick: { length: 8, lineStyle: { color: 'auto', width: 1 } },
                        splitLine: { length: 12, lineStyle: { color: 'auto', width: 2 } },
                        axisLabel: { distance: -20, color: '#868E96', fontSize: 12 },
                        title: { offsetCenter: [0,'-5%'], fontSize: 12, color: '#868E96' },
                        detail: { valueAnimation: true, fontSize: 24, offsetCenter: [0,'30%'], fontWeight: 600, formatter: v => v + 'åˆ†', color: 'inherit' },
                        data: [{ value: 0, name: 'å¾—åˆ†' }]
                    }]
                };
                scoreChart.setOption(option);
            }

            function updateScoreDashboard(value) {
                if (!scoreChart) return;
                const v = Math.max(0, Math.min(100, Number(value) || 0));
                scoreChart.setOption({ series: [{ data: [{ value: v, name: 'å¾—åˆ†' }] }] });
            }

            initDashboard();

            // è¯­éŸ³è¯„åˆ†æ¨¡å—
            const speechModule = document.getElementById('speech');
            if (speechModule) {
                const getSentenceBtn = speechModule.querySelector('.generate-sentence-btn');
                const sentenceDisplay = speechModule.querySelector('.sentence-box');
                const recordBtn = speechModule.querySelector('.rec-btn');
                const scoreDisplay = speechModule.querySelector('.score-display');
                const timerDisplay = speechModule.querySelector('.timer');
                const useSimpleScoringCheckbox = speechModule.querySelector('#useSimpleScoring');
                const useDetailedScoringCheckbox = speechModule.querySelector('#useDetailedScoring');

                let currentSentence = '';
                let audioBlob = null;
                let isSimpleScoring = useSimpleScoringCheckbox ? useSimpleScoringCheckbox.checked : true; // é»˜è®¤ä½¿ç”¨ç®€åŒ–æ¨¡å¼
                let isDetailedScoring = useDetailedScoringCheckbox ? useDetailedScoringCheckbox.checked : false; // é»˜è®¤ä¸ä½¿ç”¨è¯¦ç»†åˆ†æ

                // æ·»åŠ è¯„åˆ†æ¨¡å¼åˆ‡æ¢ç›‘å¬å™¨
                if (useSimpleScoringCheckbox) {
                    useSimpleScoringCheckbox.addEventListener('change', function() {
                        isSimpleScoring = this.checked;
                        console.log(`ç®€åŒ–è¯„åˆ†æ¨¡å¼: ${isSimpleScoring ? 'å¼€å¯' : 'å…³é—­'}`);
                        
                        if (isSimpleScoring) {
                            // åˆ‡æ¢åˆ°ç®€åŒ–æ¨¡å¼æ—¶ï¼Œé‡ç½®è¯„åˆ†æ˜¾ç¤º
                            scoreDisplay.textContent = '0';
                            scoreDisplay.style.color = '#3A86FF';
                            document.querySelector('.score-rating').textContent = 'æœªè¯„åˆ†';
                            clearDetailedResults();
                        }
                    });
                }
                
                if (useDetailedScoringCheckbox) {
                    useDetailedScoringCheckbox.addEventListener('change', function() {
                        isDetailedScoring = this.checked;
                        console.log(`è¯¦ç»†è¯„åˆ†æ¨¡å¼: ${isDetailedScoring ? 'å¼€å¯' : 'å…³é—­'}`);
                        
                        if (!isDetailedScoring) {
                            clearDetailedResults();
                        }
                    });
                }

                // æ¸…ç†è¯¦ç»†ç»“æœæ˜¾ç¤º
                function clearDetailedResults() {
                    const detailedResultsContainer = document.getElementById('detailed-results');
                    if (detailedResultsContainer) {
                        detailedResultsContainer.remove();
                    }
                }

                // æ˜¾ç¤ºè¯¦ç»†è¯„åˆ†ç»“æœ
                function displayDetailedResults(result) {
                    // æ¸…ç†ä¹‹å‰çš„ç»“æœ
                    clearDetailedResults();
                    
                    // åˆ›å»ºè¯¦ç»†ç»“æœå®¹å™¨
                    const detailedContainer = document.createElement('div');
                    detailedContainer.id = 'detailed-results';
                    detailedContainer.style.cssText = `
                        margin-top: 24px; 
                        padding: 16px; 
                        background: #F8F9FA; 
                        border-radius: 8px; 
                        border: 1px solid #E9ECEF;
                        max-height: 500px;
                        overflow-y: auto;
                    `;
                    
                    let detailedHTML = `
                        <h4 style="margin-bottom: 16px; color: #495057; font-size: 1.1rem;">ğŸ” è¯¦ç»†åˆ†æç»“æœ</h4>
                    `;
                    
                    // æ˜¾ç¤ºå•è¯çº§è¯„åˆ†å’Œå»ºè®®ï¼ˆä¼˜å…ˆæ˜¾ç¤ºï¼‰
                    if (result.word_scores && result.word_scores.length > 0) {
                        // ç­›é€‰éœ€è¦æ”¹è¿›çš„å•è¯
                        const wordsNeedingImprovement = result.word_scores.filter(ws => ws.needs_improvement);
                        
                        if (wordsNeedingImprovement.length > 0) {
                            detailedHTML += `
                                <div style="margin-bottom: 20px; padding: 12px; background: #FFF5F5; border-left: 4px solid #E63946; border-radius: 4px;">
                                    <h5 style="margin-bottom: 12px; color: #E63946; font-size: 1rem;">ğŸ¯ éœ€è¦é‡ç‚¹æ”¹è¿›çš„å•è¯:</h5>
                            `;
                            
                            wordsNeedingImprovement.forEach(wordInfo => {
                                const qualityColor = {
                                    'excellent': '#52B788',
                                    'good': '#3A86FF', 
                                    'fair': '#FFD166',
                                    'poor': '#E63946',
                                    'unknown': '#868E96'
                                }[wordInfo.quality] || '#868E96';
                                
                                const qualityText = {
                                    'excellent': 'ä¼˜ç§€',
                                    'good': 'è‰¯å¥½', 
                                    'fair': 'ä¸€èˆ¬',
                                    'poor': 'è¾ƒå·®',
                                    'unknown': 'æœªçŸ¥'
                                }[wordInfo.quality] || 'æœªçŸ¥';
                                
                                detailedHTML += `
                                    <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #E9ECEF;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <strong style="color: #495057; font-size: 1rem;">'${wordInfo.word}'</strong>
                                            <span style="
                                                padding: 3px 8px; 
                                                background: ${qualityColor}; 
                                                color: white; 
                                                border-radius: 12px; 
                                                font-size: 0.8rem;
                                                font-weight: 600;
                                            ">${wordInfo.score.toFixed(1)}åˆ† (${qualityText})</span>
                                        </div>
                                `;
                                
                                // æ˜¾ç¤ºè¯¥å•è¯çš„å…·ä½“å»ºè®®
                                if (wordInfo.suggestions && wordInfo.suggestions.length > 0) {
                                    detailedHTML += `
                                        <div style="margin-left: 16px;">
                                            <p style="font-size: 0.9rem; color: #495057; margin-bottom: 4px; font-weight: 600;">ğŸ’¡ æ”¹è¿›å»ºè®®:</p>
                                            <ul style="margin-left: 16px; margin-bottom: 8px;">
                                    `;
                                    wordInfo.suggestions.forEach(suggestion => {
                                        detailedHTML += `<li style="color: #495057; font-size: 0.85rem; margin-bottom: 2px;">${suggestion}</li>`;
                                    });
                                    detailedHTML += `</ul>`;
                                }
                                
                                // æ˜¾ç¤ºéŸ³ç´ çº§è¯¦æƒ…ï¼ˆå¯å±•å¼€ï¼‰
                                if (wordInfo.phoneme_scores && wordInfo.phoneme_scores.length > 0) {
                                    detailedHTML += `
                                        <details style="margin-left: 16px;">
                                            <summary style="cursor: pointer; color: #3A86FF; font-size: 0.85rem;">ğŸ“Š æŸ¥çœ‹éŸ³ç´ è¯¦æƒ…</summary>
                                            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                                    `;
                                    wordInfo.phoneme_scores.forEach(ps => {
                                        const phonemeColor = {
                                            'excellent': '#52B788',
                                            'good': '#3A86FF',
                                            'fair': '#FFD166',
                                            'poor': '#E63946'
                                        }[ps.quality] || '#868E96';
                                        
                                        detailedHTML += `
                                            <span style="
                                                display: inline-block;
                                                padding: 2px 6px;
                                                background: ${phonemeColor};
                                                color: white;
                                                border-radius: 3px;
                                                font-size: 0.75rem;
                                                margin: 1px;
                                            " title="è¯„åˆ†: ${ps.score.toFixed(1)}">
                                                ${ps.phoneme} (${ps.score.toFixed(0)})
                                            </span>
                                        `;
                                    });
                                    detailedHTML += `
                                            </div>
                                        </details>
                                    `;
                                }
                                
                                detailedHTML += `</div>`;
                            });
                            
                            detailedHTML += `</div>`;
                        }
                        
                        // æ˜¾ç¤ºè¡¨ç°è‰¯å¥½çš„å•è¯ï¼ˆé¼“åŠ±ï¼‰
                        const goodWords = result.word_scores.filter(ws => !ws.needs_improvement && ws.score > 0);
                        if (goodWords.length > 0) {
                            detailedHTML += `
                                <div style="margin-bottom: 16px; padding: 12px; background: #F0F8F0; border-left: 4px solid #52B788; border-radius: 4px;">
                                    <h5 style="margin-bottom: 8px; color: #52B788; font-size: 0.95rem;">ğŸŒŸ å‘éŸ³è‰¯å¥½çš„å•è¯:</h5>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            `;
                            goodWords.forEach(wordInfo => {
                                detailedHTML += `
                                    <span style="
                                        padding: 4px 8px;
                                        background: #52B788;
                                        color: white;
                                        border-radius: 12px;
                                        font-size: 0.85rem;
                                        font-weight: 500;
                                    ">'${wordInfo.word}' (${wordInfo.score.toFixed(1)})</span>
                                `;
                            });
                            detailedHTML += `
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // æ˜¾ç¤ºéŸ³ç´ çº§è¯„åˆ†ï¼ˆæŠ˜å æ˜¾ç¤ºï¼Œé¿å…è¿‡äºå†—é•¿ï¼‰
                    if (result.phoneme_scores && result.phoneme_scores.length > 0) {
                        detailedHTML += `
                            <details style="margin-bottom: 16px;">
                                <summary style="cursor: pointer; color: #3A86FF; font-weight: 600; margin-bottom: 8px;">ğŸ”Š æŸ¥çœ‹å®Œæ•´éŸ³ç´ åˆ†æ (${result.phoneme_scores.length}ä¸ªéŸ³ç´ )</summary>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px; padding: 8px; background: white; border-radius: 4px;">
                        `;
                        
                        result.phoneme_scores.forEach(ps => {
                            let bgColor = '#52B788';  // ç»¿è‰²ï¼ˆä¼˜ç§€ï¼‰
                            if (ps.quality === 'good') bgColor = '#3A86FF';      // è“è‰²ï¼ˆè‰¯å¥½ï¼‰
                            else if (ps.quality === 'fair') bgColor = '#FFD166';  // é»„è‰²ï¼ˆä¸€èˆ¬ï¼‰
                            else if (ps.quality === 'poor') bgColor = '#E63946';  // çº¢è‰²ï¼ˆè¾ƒå·®ï¼‰
                            
                            detailedHTML += `
                                <span style="
                                    display: inline-block; 
                                    padding: 4px 8px; 
                                    margin: 2px; 
                                    background: ${bgColor};
                                    color: white; 
                                    border-radius: 4px; 
                                    font-size: 0.9rem;
                                    cursor: pointer;
                                " title="è¯„åˆ†: ${ps.score.toFixed(1)}, æ—¶é—´: ${ps.start_time.toFixed(2)}s-${ps.end_time.toFixed(2)}s">
                                    ${ps.phoneme} (${ps.score.toFixed(0)})
                                </span>
                            `;
                        });
                        
                        detailedHTML += `
                                </div>
                                <p style="font-size: 0.8rem; color: #868E96; margin-top: 8px;">
                                    é¢œè‰²è¯´æ˜: <span style="color: #52B788;">â–ˆ ä¼˜ç§€</span> 
                                    <span style="color: #3A86FF;">â–ˆ è‰¯å¥½</span> 
                                    <span style="color: #FFD166;">â–ˆ ä¸€èˆ¬</span> 
                                    <span style="color: #E63946;">â–ˆ éœ€æ”¹è¿›</span>
                                </p>
                            </details>
                        `;
                    }
                    
                    // æ˜¾ç¤ºå‘ç°çš„é—®é¢˜ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (result.pronunciation_issues && result.pronunciation_issues.length > 0) {
                        detailedHTML += `
                            <details style="margin-bottom: 16px;">
                                <summary style="cursor: pointer; color: #E63946; font-weight: 600;">âš ï¸ å‘ç°çš„æŠ€æœ¯é—®é¢˜ (${result.pronunciation_issues.length}é¡¹)</summary>
                                <ul style="margin-left: 16px; color: #495057; margin-top: 8px;">
                        `;
                        result.pronunciation_issues.forEach(issue => {
                            detailedHTML += `<li style="margin-bottom: 4px; font-size: 0.9rem;">${issue}</li>`;
                        });
                        detailedHTML += `</ul></details>`;
                    }
                    
                    // æ˜¾ç¤ºæ”¹è¿›å»ºè®®ï¼ˆé‡è¦ï¼Œå§‹ç»ˆå±•å¼€ï¼‰
                    if (result.improvement_suggestions && result.improvement_suggestions.length > 0) {
                        detailedHTML += `
                            <div style="margin-bottom: 16px; padding: 12px; background: #F0F4FF; border-left: 4px solid #3A86FF; border-radius: 4px;">
                                <h5 style="margin-bottom: 8px; color: #3A86FF; font-weight: 600;">ğŸ’¡ ç»¼åˆæ”¹è¿›å»ºè®®:</h5>
                                <div style="color: #495057; line-height: 1.5;">
                        `;
                        result.improvement_suggestions.forEach(suggestion => {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡é¢˜è¡Œï¼ˆåŒ…å«emojiæˆ–ç‰¹æ®Šå­—ç¬¦ï¼‰
                            if (suggestion.match(/^[\u{1F300}-\u{1F9FF}]|^\s*[\u2022\u2023\u25E6\u2043\u2219]/u) || 
                                suggestion.includes(':')) {
                                detailedHTML += `<p style="font-weight: 600; margin: 8px 0 4px 0; color: #3A86FF;">${suggestion}</p>`;
                            } else {
                                detailedHTML += `<p style="margin: 4px 0; padding-left: 12px;">${suggestion}</p>`;
                            }
                        });
                        detailedHTML += `</div></div>`;
                    }
                    
                    // æ˜¾ç¤ºç»ƒä¹ ç»Ÿè®¡ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (result.duration_analysis) {
                        detailedHTML += `
                            <details style="margin-bottom: 8px;">
                                <summary style="cursor: pointer; color: #868E96; font-size: 0.9rem;">ğŸ“Š è¯­éŸ³åˆ†ææ•°æ®</summary>
                                <div style="font-size: 0.8rem; color: #495057; margin-top: 8px;">
                                    <p>æ€»æ—¶é•¿: ${result.duration_analysis.total_duration?.toFixed(2) || 'æœªçŸ¥'}ç§’</p>
                                    <p>è¯­é€Ÿ: ${result.duration_analysis.speech_rate?.toFixed(1) || 'æœªçŸ¥'} éŸ³ç´ /ç§’</p>
                                    <p>å¹³å‡éŸ³ç´ æ—¶é•¿: ${result.duration_analysis.avg_phoneme_duration?.toFixed(3) || 'æœªçŸ¥'}ç§’</p>
                                </div>
                            </details>
                        `;
                    }
                    
                    detailedContainer.innerHTML = detailedHTML;
                    
                    // å°†è¯¦ç»†ç»“æœæ·»åŠ åˆ°å³ä¾§é¢æ¿
                    const dashboard = speechModule.querySelector('.dashboard');
                    if (dashboard) {
                        dashboard.appendChild(detailedContainer);
                    }
                }
                getSentenceBtn.addEventListener('click', async () => {
                    try {
                        const response = await axios.get('/api/random-english-sentence');
                        currentSentence = response.data.sentence;
                        sentenceDisplay.textContent = currentSentence;
                        scoreDisplay.textContent = '0';
                        scoreDisplay.style.color = '#3A86FF';
                        document.querySelector('.score-rating').textContent = 'æœªè¯„åˆ†';
                        updateScoreDashboard(0);
                    } catch (error) {
                        console.error('è·å–å¥å­å¤±è´¥:', error);
                        alert('è·å–å¥å­å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });

                // å½•éŸ³åŠŸèƒ½å®ç°
                let mediaRecorder;
                let audioChunks = [];
                let recordingTimer;
                let seconds = 0;
                let minutes = 0;

                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                function formatTime() {
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }

                // æ›´æ–°è®¡æ—¶å™¨
                function updateTimer() {
                    seconds++;
                    if (seconds >= 60) {
                        seconds = 0;
                        minutes++;
                    }
                    timerDisplay.textContent = formatTime();
                }

                // å¼€å§‹å½•éŸ³
                async function startRecording() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];

                        mediaRecorder.ondataavailable = event => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                            }
                        };

                        mediaRecorder.onstop = () => {
                            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            stream.getTracks().forEach(track => track.stop());
                            alert('å½•éŸ³å®Œæˆ');
                            initWaveform(); // æ›´æ–°æ³¢å½¢å›¾
                        };

                        mediaRecorder.start();
                        seconds = 0;
                        minutes = 0;
                        timerDisplay.textContent = formatTime();
                        recordingTimer = setInterval(updateTimer, 1000);
                    } catch (error) {
                        console.error('å½•éŸ³æƒé™è¯·æ±‚å¤±è´¥:', error);
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£ã€‚è¯·ç¡®ä¿å·²æˆäºˆéº¦å…‹é£æƒé™å¹¶å°è¯•å†æ¬¡å½•éŸ³ã€‚');
                        recorder.classList.remove('recording');
                    }
                }

                // åœæ­¢å½•éŸ³
                function stopRecording() {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        clearInterval(recordingTimer);
                    }
                }

                // å½•éŸ³æŒ‰é’®çŠ¶æ€åˆ‡æ¢
                recordBtn.addEventListener('click', () => {
                    // ç¡®ä¿æœ‰å¥å­æ‰èƒ½å½•éŸ³
                    if (!currentSentence) {
                        alert('è¯·å…ˆç‚¹å‡»"ç”Ÿæˆæ–°å¥å­"æŒ‰é’®è·å–å¥å­');
                        return;
                    }

                    const recorder = recordBtn.closest('.recorder');
                    recorder.classList.toggle('recording');

                    if (recorder.classList.contains('recording')) {
                        startRecording();
                    } else {
                        stopRecording();
                        timerDisplay.textContent = '00:00';
                    }
                });

                // æ·»åŠ æäº¤è¯„åˆ†æŒ‰é’®äº‹ä»¶
                const submitScoreBtn = document.createElement('button');
                submitScoreBtn.textContent = 'æäº¤è¯„åˆ†';
                submitScoreBtn.style.cssText = 'background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px;';
                speechModule.querySelector('.panel').appendChild(submitScoreBtn);

                // æäº¤è¯„åˆ†
                submitScoreBtn.addEventListener('click', async () => {
                    if (!currentSentence || !audioBlob) {
                        alert('è¯·å…ˆè·å–å¥å­å¹¶å®Œæˆå½•éŸ³');
                        return;
                    }

                    try {
                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        submitScoreBtn.textContent = 'è¯„åˆ†ä¸­...';
                        submitScoreBtn.disabled = true;
                        
                        // æ¸…ç†ä¹‹å‰çš„è¯¦ç»†ç»“æœ
                        clearDetailedResults();
                        
                        // æ£€æŸ¥ç”¨æˆ·é€‰æ‹©çš„è¯„åˆ†æ¨¡å¼
                        const useSimpleScoring = useSimpleScoringCheckbox ? useSimpleScoringCheckbox.checked : true;
                        const useDetailedScoring = useDetailedScoringCheckbox ? useDetailedScoringCheckbox.checked : false;
                        
                        let apiEndpoint;
                        let modeText;
                        
                        if (useDetailedScoring) {
                            apiEndpoint = '/api/score-pronunciation-detailed';
                            modeText = 'éŸ³ç´ çº§è¯¦ç»†æ¨¡å¼';
                        } else if (useSimpleScoring) {
                            apiEndpoint = '/api/score-pronunciation-simple';
                            modeText = 'ç®€åŒ–æ¨¡å¼';
                        } else {
                            apiEndpoint = '/api/score-pronunciation';
                            modeText = 'å®Œæ•´æ¨¡å¼';
                        }
                        
                        console.log(`ä½¿ç”¨${modeText}ï¼Œæ¥å£: ${apiEndpoint}`);
                        
                        const formData = new FormData();
                        formData.append('reference_text', currentSentence);
                        formData.append('audio_file', audioBlob, 'recording.webm');

                        console.log('æ­£åœ¨æäº¤è¯„åˆ†è¯·æ±‚...');
                        const response = await axios.post(apiEndpoint, formData);
                        console.log('è¯„åˆ†å“åº”:', response.data);
                        
                        if (response.data.error) {
                            throw new Error(response.data.error);
                        }
                        
                        // å¤„ç†ä¸åŒç±»å‹çš„è¯„åˆ†ç»“æœ
                        let score, detailedResult = null;
                        
                        if (useDetailedScoring && response.data.overall_score !== undefined) {
                            // è¯¦ç»†è¯„åˆ†ç»“æœ
                            score = response.data.overall_score;
                            detailedResult = response.data;
                        } else {
                            // ç®€å•è¯„åˆ†ç»“æœ
                            score = response.data.score;
                        }
                        
                        // æ›´æ–°è¯„åˆ†æ˜¾ç¤º
                        scoreDisplay.textContent = score;
                        updateScoreDashboard(score);
                        
                        // æ›´æ–°è¯„åˆ†ç­‰çº§
                        const scoreNum = parseFloat(score);
                        if (scoreNum >= 90) {
                            document.querySelector('.score-rating').textContent = 'ä¼˜ç§€';
                            scoreDisplay.style.color = '#52B788';
                        } else if (scoreNum >= 75) {
                            document.querySelector('.score-rating').textContent = 'è‰¯å¥½';
                            scoreDisplay.style.color = '#3A86FF';
                        } else if (scoreNum >= 60) {
                            document.querySelector('.score-rating').textContent = 'åŠæ ¼';
                            scoreDisplay.style.color = '#FFD166';
                        } else {
                            document.querySelector('.score-rating').textContent = 'éœ€è¦æ”¹è¿›';
                            scoreDisplay.style.color = '#E63946';
                        }
                        
                        // æ˜¾ç¤ºè¯¦ç»†ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
                        if (detailedResult && detailedResult.detailed !== false) {
                            displayDetailedResults(detailedResult);
                            alert(`è¯„åˆ†å®Œæˆï¼æ‚¨çš„å¾—åˆ†æ˜¯ï¼š${score}åˆ†\nï¼ˆä½¿ç”¨${modeText}ï¼‰\nè¯·æŸ¥çœ‹ä¸‹æ–¹çš„è¯¦ç»†åˆ†æç»“æœ`);
                        } else {
                            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                            alert(`è¯„åˆ†å®Œæˆï¼æ‚¨çš„å¾—åˆ†æ˜¯ï¼š${score}åˆ†\nï¼ˆä½¿ç”¨${modeText}ï¼‰`);
                        }
                        
                    } catch (error) {
                        console.error('è¯„åˆ†å¤±è´¥:', error);
                        
                        let errorMessage = 'è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•';
                        if (error.response && error.response.data && error.response.data.error) {
                            errorMessage = `è¯„åˆ†å¤±è´¥ï¼š${error.response.data.error}`;
                        } else if (error.message) {
                            errorMessage = `è¯„åˆ†å¤±è´¥ï¼š${error.message}`;
                        }
                        
                        alert(errorMessage);
                        
                        // å¦‚æœå®Œæ•´æ¨¡å¼å¤±è´¥ï¼Œå»ºè®®ç”¨æˆ·åˆ‡æ¢åˆ°ç®€åŒ–æ¨¡å¼
                        if (!useSimpleScoringCheckbox.checked && !useDetailedScoringCheckbox.checked) {
                            if (confirm('å®Œæ•´è¯„åˆ†æ¨¡å¼å¤±è´¥ï¼Œæ˜¯å¦åˆ‡æ¢åˆ°ç®€åŒ–æ¨¡å¼é‡è¯•ï¼Ÿ')) {
                                useSimpleScoringCheckbox.checked = true;
                                alert('å·²åˆ‡æ¢åˆ°ç®€åŒ–æ¨¡å¼ï¼Œè¯·é‡æ–°ç‚¹å‡»"æäº¤è¯„åˆ†"æŒ‰é’®');
                            }
                        }
                        
                        // é‡ç½®è¯„åˆ†æ˜¾ç¤º
                        scoreDisplay.textContent = '0';
                        scoreDisplay.style.color = '#3A86FF';
                        document.querySelector('.score-rating').textContent = 'è¯„åˆ†å¤±è´¥';
                    } finally {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        submitScoreBtn.textContent = 'æäº¤è¯„åˆ†';
                        submitScoreBtn.disabled = false;
                    }
                });
            }

            // è¯­æ³•æ£€æµ‹æ¨¡å—
            const grammarModule = document.getElementById('grammar');
            if (grammarModule) {
                const getChineseBtn = grammarModule.querySelector('.generate-sentence-btn');
                const chineseDisplay = grammarModule.querySelector('.sentence-box');
                const translatedInput = grammarModule.querySelector('textarea');
                const recordGrammarBtn = grammarModule.querySelector('.rec-btn');
                const errorTextDisplay = grammarModule.querySelector('.error-text');

                let currentChinese = '';
                let grammarMediaRecorder = null;
                let grammarChunks = [];
                let grammarAudioBlob = null;

                // è·å–éšæœºä¸­æ–‡å¥å­
                getChineseBtn.addEventListener('click', async () => {
                    try {
                        const response = await axios.get('/api/random-chinese-sentence');
                        currentChinese = response.data.sentence;
                        chineseDisplay.textContent = currentChinese;
                        translatedInput.value = '';
                        errorTextDisplay.innerHTML = '<p>è¯·è¾“å…¥è‹±æ–‡ç¿»è¯‘ï¼ˆå¯é€‰å½•éŸ³ï¼‰...</p>';
                        grammarAudioBlob = null;
                    } catch (error) {
                        console.error('è·å–ä¸­æ–‡å¥å­å¤±è´¥:', error);
                        alert('è·å–ä¸­æ–‡å¥å­å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });

                // å½•éŸ³åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
                recordGrammarBtn.addEventListener('click', async () => {
                    if (!currentChinese) {
                        alert('è¯·å…ˆè·å–ä¸­æ–‡å¥å­');
                        return;
                    }

                    const container = recordGrammarBtn.closest('.panel');
                    container.classList.toggle('recording');

                    try {
                        if (container.classList.contains('recording')) {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            grammarChunks = [];
                            grammarMediaRecorder = new MediaRecorder(stream);
                            grammarMediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) grammarChunks.push(e.data); };
                            grammarMediaRecorder.onstop = () => {
                                grammarAudioBlob = new Blob(grammarChunks, { type: 'audio/webm' });
                                stream.getTracks().forEach(t => t.stop());
                                alert('å½•éŸ³å®Œæˆ');
                            };
                            grammarMediaRecorder.start();
                        } else {
                            if (grammarMediaRecorder && grammarMediaRecorder.state !== 'inactive') {
                                grammarMediaRecorder.stop();
                            }
                        }
                    } catch (err) {
                        console.error('å½•éŸ³å¤±è´¥:', err);
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£');
                        container.classList.remove('recording');
                    }
                });

                // æ·»åŠ æäº¤è¯­æ³•æ£€æµ‹æŒ‰é’®
                const submitGrammarBtn = document.createElement('button');
                submitGrammarBtn.textContent = 'æäº¤æ£€æµ‹';
                submitGrammarBtn.style.cssText = 'background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px;';
                grammarModule.querySelector('.panel').appendChild(submitGrammarBtn);

                // æäº¤è¯­æ³•æ£€æµ‹ï¼ˆéŸ³é¢‘å¯é€‰ï¼‰
                submitGrammarBtn.addEventListener('click', async () => {
                    if (!currentChinese || !translatedInput.value.trim()) {
                        alert('è¯·å…ˆè·å–ä¸­æ–‡å¥å­å¹¶è¾“å…¥è‹±æ–‡ç¿»è¯‘');
                        return;
                    }

                    try {
                        const formData = new FormData();
                        formData.append('translated_text', translatedInput.value.trim());
                        if (grammarAudioBlob) {
                            formData.append('audio_file', grammarAudioBlob, 'grammar_recording.webm');
                        }

                        const response = await axios.post('/api/check-grammar', formData);
                        const result = response.data.result;
                        if (result.status === 'success') {
                            errorTextDisplay.innerHTML = '<span class="text-green-600">âœ… è‹±æ–‡è¯­æ³•æ­£ç¡®!</span>';
                        } else {
                            let errorHtml = `<div class="text-red-600">âŒ æ£€æµ‹åˆ° ${result.error_count} å¤„è¯­æ³•é—®é¢˜:</div>`;
                            result.errors.forEach((error, index) => {
                                errorHtml += `
<div class="mt-2 p-2 bg-red-50 rounded">
  <div><strong>ã€é”™è¯¯ ${index + 1}ã€‘</strong></div>
  <div>ğŸ“Œ è§„åˆ™ID: ${error.rule_id}</div>
  <div>â— é—®é¢˜æè¿°: ${error.message}</div>
  <div>ğŸ” ä¸Šä¸‹æ–‡: ${error.context}</div>
  <div>ğŸ’¡ å»ºè®®æ›¿æ¢: ${error.replacements.join(', ')}</div>
</div>`;
                            });
                            errorTextDisplay.innerHTML = errorHtml;
                        }
                    } catch (error) {
                        console.error('è¯­æ³•æ£€æµ‹å¤±è´¥:', error);
                        alert('è¯­æ³•æ£€æµ‹å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });
            }

            // æ–‡ä»¶ä¸Šä¼ æ•ˆæœ
            const uploadArea = document.querySelector('.upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#3A86FF';
                    uploadArea.style.backgroundColor = '#F1F8FF';
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.style.borderColor = '#DEE2E6';
                    uploadArea.style.backgroundColor = 'white';
                });
            }

            // è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å— - æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
            const customModule = document.getElementById('custom');
            if (customModule) {
                const modeBtns = customModule.querySelectorAll('.mode-btn');
                const audioUploadArea = customModule.querySelector('.upload-area');
                const fileList = customModule.querySelector('.upload-area + div');
                
                // åˆ›å»ºæ–‡æœ¬ç»ƒä¹ åŒºåŸŸ
                const textExerciseArea = document.createElement('div');
                textExerciseArea.style.display = 'none';
                textExerciseArea.innerHTML = `
                    <textarea rows="8" style="width: 100%; padding: 16px; border: 1px solid #DEE2E6; border-radius: 6px; font-size: 1rem; margin-bottom: 16px;" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç²˜è´´æ‚¨çš„æ–‡æœ¬ç»ƒä¹ ææ–™..."></textarea>
                    <button style="background: #3A86FF; color: white; padding: 10px 24px; border-radius: 6px; border: none; cursor: pointer;">å¯¼å…¥æ–‡æœ¬</button>
                `;
                
                // å°†æ–‡æœ¬ç»ƒä¹ åŒºåŸŸæ’å…¥åˆ°DOMä¸­
                audioUploadArea.parentNode.insertBefore(textExerciseArea, audioUploadArea.nextSibling);
                
                // ä¸ºæ¨¡å¼æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                modeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
                        modeBtns.forEach(b => b.classList.remove('active'));
                        // ä¸ºå½“å‰ç‚¹å‡»çš„æŒ‰é’®æ·»åŠ activeçŠ¶æ€
                        btn.classList.add('active');
                        
                        // æ ¹æ®é€‰æ‹©çš„æ¨¡å¼æ˜¾ç¤ºç›¸åº”çš„åŒºåŸŸ
                        if (btn.textContent.trim() === 'éŸ³é¢‘ç»ƒä¹ ') {
                            audioUploadArea.style.display = 'flex';
                            fileList.style.display = 'block';
                            textExerciseArea.style.display = 'none';
                        } else if (btn.textContent.trim() === 'æ–‡æœ¬ç»ƒä¹ ') {
                            audioUploadArea.style.display = 'none';
                            fileList.style.display = 'none';
                            textExerciseArea.style.display = 'block';
                        }
                    });
                });
            }

            // è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å— - å¼€å§‹ç»ƒä¹ å’Œæäº¤ç­”æ¡ˆæŒ‰é’®ï¼ˆé€šè¿‡æ–‡æœ¬åŒ¹é…é€‰æ‹©ï¼‰
            let startPracticeBtn = null;
            let submitAnswerBtn = null;
            document.querySelectorAll('.module#custom button').forEach(btn => {
                const text = btn.textContent.trim();
                if (text === 'å¼€å§‹ç»ƒä¹ ') startPracticeBtn = btn;
                if (text === 'æäº¤ç­”æ¡ˆ') submitAnswerBtn = btn;
            });
            const customExerciseContent = document.querySelector('.module#custom .sentence-box');
            let currentExerciseData = null;
            let currentMode = 'audio'; // é»˜è®¤éŸ³é¢‘æ¨¡å¼
            let customMediaRecorder = null;
            let customChunks = [];
            let customAudioBlob = null;
            
            // è·Ÿè¸ªå½“å‰é€‰æ‹©çš„æ¨¡å¼
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.textContent.trim() === 'éŸ³é¢‘ç»ƒä¹ ') {
                        currentMode = 'audio';
                    } else if (btn.textContent.trim() === 'æ–‡æœ¬ç»ƒä¹ ') {
                        currentMode = 'text';
                    }
                });
            });
            
            if (startPracticeBtn) {
                startPracticeBtn.addEventListener('click', async () => {
                    try {
                        const mode = currentMode === 'audio' ? 'speech' : 'grammar';
                        const response = await axios.post('/api/custom-exercise', { mode });
                        currentExerciseData = response.data;
                        customAudioBlob = null;

                        if (response.data.reference_text) {
                            customExerciseContent.innerHTML = `
                                <p style="font-size: 1.2rem; margin-bottom: 16px;">è¯·æœ—è¯»ä»¥ä¸‹å†…å®¹ï¼š</p>
                                <p id="custom-ref" style="font-size: 1.5rem; font-weight: 500; color: #212529;">${response.data.reference_text}</p>
                            `;

                            // éŸ³é¢‘æ¨¡å¼ï¼šå¼€å§‹å½•éŸ³
                            try {
                                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                                customChunks = [];
                                customMediaRecorder = new MediaRecorder(stream);
                                customMediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) customChunks.push(e.data); };
                                customMediaRecorder.onstop = () => {
                                    customAudioBlob = new Blob(customChunks, { type: 'audio/webm' });
                                    stream.getTracks().forEach(t => t.stop());
                                };
                                customMediaRecorder.start();
                            } catch (e) {
                                console.error('è‡ªå®šä¹‰ç»ƒä¹ å½•éŸ³å¤±è´¥:', e);
                                alert('æ— æ³•è®¿é—®éº¦å…‹é£');
                            }
                        } else if (response.data.chinese_sentence) {
                            customExerciseContent.innerHTML = `
                                <p style="font-size: 1.2rem; margin-bottom: 16px;">è¯·ç¿»è¯‘ä»¥ä¸‹ä¸­æ–‡ï¼š</p>
                                <p style="font-size: 1.5rem; font-weight: 500; color: #212529;">${response.data.chinese_sentence}</p>
                            `;
                        }
                    } catch (error) {
                        console.error('è·å–ç»ƒä¹ æ•°æ®å¤±è´¥:', error);
                        alert('è·å–ç»ƒä¹ æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });
            }
            
            if (submitAnswerBtn) {
                submitAnswerBtn.addEventListener('click', async () => {
                    if (!currentExerciseData) {
                        alert('è¯·å…ˆç‚¹å‡»"å¼€å§‹ç»ƒä¹ "æŒ‰é’®');
                        return;
                    }

                    if (currentMode === 'audio') {
                        // åœæ­¢å½•éŸ³å¹¶æäº¤è¯„åˆ†
                        try {
                            if (customMediaRecorder && customMediaRecorder.state !== 'inactive') {
                                await new Promise(resolve => {
                                    customMediaRecorder.onstop = () => { 
                                        customAudioBlob = new Blob(customChunks, { type: 'audio/webm' });
                                        resolve();
                                    };
                                    customMediaRecorder.stop();
                                });
                            }
                        } catch (e) { /* å¿½ç•¥ */ }

                        if (!customAudioBlob) {
                            alert('æœªæ•è·åˆ°éŸ³é¢‘ï¼Œè¯·é‡è¯•');
                            return;
                        }

                        try {
                            const refEl = document.getElementById('custom-ref');
                            const referenceText = refEl ? refEl.textContent : (currentExerciseData.reference_text || '');
                            const fd = new FormData();
                            fd.append('reference_text', referenceText);
                            fd.append('audio_file', customAudioBlob, 'custom_recording.webm');
                            const resp = await axios.post('/api/score-pronunciation', fd);
                            const score = resp.data.score || '0';
                            customExerciseContent.innerHTML += `
                                <div style="margin-top: 24px; padding: 16px; background: #F8F9FA; border-radius: 6px;">
                                    <p style="font-size: 1.2rem; font-weight: 600; color: #3A86FF;">ç»ƒä¹ å®Œæˆï¼</p>
                                    <p style="font-size: 2rem; font-weight: 800; color: #3A86FF; margin-top: 12px;">${score}</p>
                                </div>
                            `;
                        } catch (err) {
                            console.error('æäº¤è¯„åˆ†å¤±è´¥:', err);
                            alert('æäº¤è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    } else {
                        // æ–‡æœ¬ç»ƒä¹ ï¼šæäº¤è¯­æ³•æ£€æµ‹
                        const textarea = document.querySelector('.module#custom textarea');
                        const translatedText = textarea ? textarea.value.trim() : '';
                        if (!translatedText) {
                            alert('è¯·è¾“å…¥æ‚¨çš„ç¿»è¯‘å†…å®¹');
                            return;
                        }
                        try {
                            const fd = new FormData();
                            fd.append('translated_text', translatedText);
                            const resp = await axios.post('/api/check-grammar', fd);
                            const result = resp.data.result;
                            let html = `<div style="margin-top: 24px; padding: 16px; background: #F8F9FA; border-radius: 6px;">`;
                            if (result.status === 'success') {
                                html += `<span style="color:#52B788">âœ… è¯­æ³•æ­£ç¡®ï¼</span>`;
                            } else {
                                html += `<div style="color:#E63946">âŒ æ£€æµ‹åˆ° ${result.error_count} å¤„è¯­æ³•é—®é¢˜ï¼š</div>`;
                                result.errors.forEach((e, i) => {
                                    html += `<div class="mt-2 p-2 bg-red-50 rounded">ã€é”™è¯¯ ${i+1}ã€‘ ${e.message}</div>`;
                                });
                            }
                            html += `</div>`;
                            customExerciseContent.innerHTML += html;
                        } catch (err) {
                            console.error('æäº¤è¯­æ³•æ£€æµ‹å¤±è´¥:', err);
                            alert('æäº¤è¯­æ³•æ£€æµ‹å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    }
                });
            }
            
            // å¯¼å…¥æ–‡æœ¬æŒ‰é’®äº‹ä»¶ - ä½¿ç”¨æ ‡å‡†JavaScriptæ–¹æ³•æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ–‡æœ¬çš„æŒ‰é’®
            const buttons = document.querySelectorAll('.module#custom button');
            let importTextBtn = null;
            buttons.forEach(button => {
                if (button.textContent.includes('å¯¼å…¥æ–‡æœ¬')) {
                    importTextBtn = button;
                }
            });
            
            if (importTextBtn) {
                importTextBtn.addEventListener('click', () => {
                    const textarea = document.querySelector('.module#custom textarea');
                    if (textarea && textarea.value.trim()) {
                        alert('æ–‡æœ¬å¯¼å…¥æˆåŠŸï¼ç‚¹å‡»"å¼€å§‹ç»ƒä¹ "å¼€å§‹æ‚¨çš„è‡ªå®šä¹‰ç»ƒä¹ ã€‚');
                    } else {
                        alert('è¯·å…ˆåœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥å†…å®¹');
                    }
                });
            }
        });
    </script>

</body></html>