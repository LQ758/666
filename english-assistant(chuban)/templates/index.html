<!DOCTYPE html><html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语言学习助手 | 语音评分与语法检测</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/static/test_api.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Noto Sans', system-ui, sans-serif;
            background-color: #E9F1FF;
            color: #212529;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .app-container {
            width: 1440px;
            min-height: 800px;
            padding: 32px;
            display: flex;
            flex-direction: column;
        }
        
        .content-card {
            background: #FFFFFF;
            border: 1px solid #E9ECEF;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px -4px rgba(0,0,0,0.04);
            overflow: hidden;
            flex: 1;
            padding: 32px;
        }
        
        header.navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 32px 0;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .tabs {
            display: flex;
            background: #F1F3F5;
            border-radius: 6px;
            padding: 4px;
        }
        
        .tab-btn {
            padding: 10px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #495057;
        }
        
        .tab-btn.active {
            background: #FFFFFF;
            color: #3A86FF;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        
        .module {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .module.active {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 32px;
            height: 100%;
        }
        
        .panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
            height: 100%;
        }
        
        h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 8px;
        }
        
        .description {
            color: #868E96;
            margin-bottom: 20px;
        }
        
        .sentence-box {
            background: #F8F9FA;
            padding: 24px;
            border-radius: 8px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .dashboard {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .score-display {
            font-size: 5rem;
            font-weight: 800;
            margin: 24px 0;
            transition: color 0.4s;
        }
        
        .score-rating {
            font-size: 1.4rem;
            font-weight: 600;
            color: #FB8500;
        }
        
        .chart-container {
            width: 100%;
            height: 180px;
        }
        
        .recorder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        
        .rec-btn {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #3A86FF;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.5);
        }
        
        .rec-btn:hover {
            background: #2B6BC8;
        }
        
        .recording .rec-btn {
            animation: pulse 1.5s infinite;
        }
        
        .timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
        }
        
        input, textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid #DEE2E6;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .error-text {
            background: #FFF5F5;
            padding: 24px;
            border-radius: 8px;
            position: relative;
        }
        
        .highlight {
            background: rgba(230, 57, 70, 0.12);
            color: #E63946;
            border-bottom: 2px dashed #E63946;
        }
        
        .upload-area {
            border: 2px dashed #DEE2E6;
            border-radius: 8px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-area:hover {
            border-color: #3A86FF;
        }
        
        .upload-icon {
            background: #F1F3F5;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            color: #3A86FF;
        }
        
        .file-desc {
            color: #868E96;
            margin-bottom: 16px;
        }
        
        footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 0 0 0;
            color: #868E96;
            border-top: 1px solid #E9ECEF;
            margin-top: 32px;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .progress-bar {
            width: 160px;
            height: 6px;
            background: #E9ECEF;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3A86FF;
            width: 65%;
        }
        
        .setting-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.5); }
            70% { box-shadow: 0 0 0 12px rgba(58, 134, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .mode-selector {
            display: flex;
            background: #F1F3F5;
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 24px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .mode-btn.active {
            background: #FFFFFF;
            color: #3A86FF;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="navbar">
            <div class="brand">
                <iconify-icon icon="carbon:language" width="32" height="32"></iconify-icon>
                <span>感觉差点什么的语学助手</span>
            </div>
            <div class="tabs">
                <div class="tab-btn active" data-target="speech">英语语音评分</div>
                <div class="tab-btn" data-target="grammar">英文语法检测</div>
                <div class="tab-btn" data-target="custom">自定义练习</div>
            </div>
        </header>
        
        <main class="content-card">
            <!-- 语音评分模块 -->
            <div id="speech" class="module active">
                <div class="panel">
                    <div>
                        <h2>英语发音评分</h2>
                        <p class="description">朗读以下英语句子，系统将评估您的发音准确度并给出改进建议</p>
                        <div class="sentence-box">
                            The pursuit of knowledge and innovation drives human progress.
                        </div>
                        <button class="generate-sentence-btn" style="background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px; display: flex; align-items: center; gap: 8px;">
                            <iconify-icon icon="mdi:refresh" width="20" height="20"></iconify-icon>
                            <span>生成新句子</span>
                        </button>
                    </div>
                    
                    <div class="recorder">
                        <div>
                            <p class="timer">00:00</p>
                            <button class="rec-btn">
                                <iconify-icon icon="mdi:microphone" width="32" height="32"></iconify-icon>
                            </button>
                        </div>
                        <div class="chart-container" id="waveform"></div>
                        
                        <!-- 添加评分模式切换 -->
                        <div style="margin-top: 16px; text-align: center;">
                            <label style="display: flex; align-items: center; gap: 8px; justify-content: center; cursor: pointer; margin-bottom: 8px;">
                                <input type="checkbox" id="useSimpleScoring" style="width: auto;">
                                <span style="font-size: 0.9rem; color: #495057;">使用简化评分模式</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; justify-content: center; cursor: pointer;">
                                <input type="checkbox" id="useDetailedScoring" style="width: auto;">
                                <span style="font-size: 0.9rem; color: #495057;">启用完整模式详细分析</span>
                            </label>
                            <p style="font-size: 0.8rem; color: #868E96; margin-top: 4px;">
                                简化模式更稳定，完整模式提供详细的发音改进建议
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard">
                    <h2>成绩分析</h2>
                    <div class="score-display" style="color: #3A86FF">0</div>
                    <div class="score-rating">未评分</div>
                    
                    <div class="chart-container" id="score-dashboard"></div>
                    
                    <div style="margin-top: 24px; text-align: center;">
                        <p style="margin-bottom: 12px; color: #495057">发音改善建议:</p>
                    </div>
                </div>
            </div>
            
            <!-- 语法检测模块 -->
            <div id="grammar" class="module">
                <div class="panel">
                    <div>
                        <h2>英文语法检测</h2>
                        <p class="description">输入英文文本，系统将检测语法错误并提供修改建议</p>
                        <div class="sentence-box">
                            I have went to the store yesterday and buyed some groceries.
                        </div>
                        <button class="generate-sentence-btn" style="background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px; display: flex; align-items: center; gap: 8px;">
                            <iconify-icon icon="mdi:refresh" width="20" height="20"></iconify-icon>
                            <span>生成新句子</span>
                        </button>
                    </div>
                    
                    <div>
                        <textarea rows="6" placeholder="在此输入您的英文文本...">I have went to the store yesterday and buyed some groceries.</textarea>
                        <button class="rec-btn" style="margin-top: 16px;">
                            <iconify-icon icon="mdi:microphone" width="24" height="24"></iconify-icon>
                        </button>
                    </div>
                </div>
                
                <div class="panel" style="height: 100%;">
                    <h2>语法分析</h2>
                    <div class="error-text">
                        <p>I have <span class="highlight">went</span> to the store yesterday and <span class="highlight">buyed</span> some groceries.</p>
                        <p style="margin-top: 24px;">修改建议:</p>
                        <p style="margin-top: 8px;">1. "went" 应为 "gone"（"have" 后应使用过去分词）</p>
                        <p>2. "buyed" 为错误形式，正确的过去式是 "bought"</p>
                        <p>正确形式: <strong>I have gone to the store yesterday and bought some groceries.</strong></p>
                    </div>
                </div>
            </div>
            
            <!-- 自定义练习模块 -->
            <div id="custom" class="module">
                <div class="panel">
                    <div>
                        <h2>自定义练习</h2>
                        <p class="description">上传练习材料，创建个性化学习内容</p>
                        
                        <div class="mode-selector">
                            <div class="mode-btn active">音频练习</div>
                            <div class="mode-btn">文本练习</div>
                        </div>
                        
                        <div class="upload-area">
                            <div class="upload-icon">
                                <iconify-icon icon="mdi-cloud-upload" width="32" height="32"></iconify-icon>
                            </div>
                            <h3>拖放音频文件至此处</h3>
                            <p class="file-desc">支持 MP3、WAV 格式，文件大小不超过 50MB</p>
                            <button style="background: #3A86FF; color: white; padding: 10px 24px; border-radius: 6px; border: none; cursor: pointer;">
                                选择文件
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: auto;">
                        <p style="margin-bottom: 16px; color: #495057">已上传文件:</p>
                        <div style="display: flex; gap: 12px; align-items: center; padding: 12px; border: 1px solid #E9ECEF; border-radius: 6px;">
                            <iconify-icon icon="mdi:file-music" width="24" height="24" style="color: #3A86FF;"></iconify-icon>
                            <div>
                                <p style="font-weight: 500;">custom_practice.mp3</p>
                                <p style="color: #868E96; font-size: 0.875rem;">12.5 MB • 上传于 10分钟前</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div style="height: 100%; display: flex; flex-direction: column;">
                        <h2>练习控制面板</h2>
                        <div class="sentence-box" style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                            <p>自定义练习内容将在此处显示...</p>
                        </div>
                        
                        <div style="margin-top: auto; display: flex; gap: 16px; justify-content: center;">
                            <button style="background: #E9F1FF; color: #3A86FF; padding: 12px 24px; border-radius: 6px; border: 1px solid #3A86FF; cursor: pointer;">
                                开始练习
                            </button>
                            <button style="background: #3A86FF; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer;">
                                提交答案
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <div class="setting-btn">
                <iconify-icon icon="mdi:cog" width="20" height="20"></iconify-icon>
                <span>系统设置</span>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 切换选项卡
            const tabBtns = document.querySelectorAll('.tab-btn');
            const modules = document.querySelectorAll('.module');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 移除所有激活状态
                    tabBtns.forEach(b => b.classList.remove('active'));
                    modules.forEach(m => m.classList.remove('active'));

                    // 添加当前激活状态
                    btn.classList.add('active');
                    const targetModule = document.getElementById(btn.dataset.target);
                    if (targetModule) {
                        targetModule.classList.add('active');
                    }
                });
            });

            // 默认激活第一个选项卡
            if (tabBtns.length > 0) {
                tabBtns[0].click();
            }

            // 初始化波形图
            function initWaveform() {
                const chartDom = document.getElementById('waveform');
                if (!chartDom) return;
                
                const myChart = echarts.init(chartDom);
                
                // 生成模拟录音波形数据
                const data = Array.from({length: 200}, () => Math.random() * 50);
                
                const option = {
                    grid: {
                        top: 10,
                        bottom: 10,
                        left: 0,
                        right: 0
                    },
                    xAxis: {
                        type: 'category',
                        show: false
                    },
                    yAxis: {
                        type: 'value',
                        show: false
                    },
                    series: [
                        {
                            name: '音频波形',
                            type: 'line',
                            showSymbol: false,
                            data: data,
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [
                                        {offset: 0, color: 'rgba(58, 134, 255, 0.3)'},
                                        {offset: 1, color: 'rgba(58, 134, 255, 0.05)'}
                                    ]
                                }
                            },
                            lineStyle: {
                                width: 1.5,
                                color: '#3A86FF'
                            }
                        }
                    ]
                };
                
                myChart.setOption(option);
            }

            // 初始化评分仪表盘，并暴露可更新的函数
            let scoreChart = null;
            function initDashboard() {
                const chartDom = document.getElementById('score-dashboard');
                if (!chartDom) return;
                scoreChart = echarts.init(chartDom);

                const option = {
                    tooltip: { formatter: '{a} : {c}' },
                    series: [{
                        name: '发音评分',
                        type: 'gauge',
                        startAngle: 180,
                        endAngle: 0,
                        min: 0,
                        max: 100,
                        radius: '100%',
                        center: ['50%', '60%'],
                        splitNumber: 10,
                        axisLine: { lineStyle: { width: 10, color: [[0.6,'#FFD166'],[0.8,'#3A86FF'],[1,'#52B788']] } },
                        pointer: { icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z', length: '12%', width: 10, offsetCenter: [0,'-60%'], itemStyle: { color: '#495057' } },
                        axisTick: { length: 8, lineStyle: { color: 'auto', width: 1 } },
                        splitLine: { length: 12, lineStyle: { color: 'auto', width: 2 } },
                        axisLabel: { distance: -20, color: '#868E96', fontSize: 12 },
                        title: { offsetCenter: [0,'-5%'], fontSize: 12, color: '#868E96' },
                        detail: { valueAnimation: true, fontSize: 24, offsetCenter: [0,'30%'], fontWeight: 600, formatter: v => v + '分', color: 'inherit' },
                        data: [{ value: 0, name: '得分' }]
                    }]
                };
                scoreChart.setOption(option);
            }

            function updateScoreDashboard(value) {
                if (!scoreChart) return;
                const v = Math.max(0, Math.min(100, Number(value) || 0));
                scoreChart.setOption({ series: [{ data: [{ value: v, name: '得分' }] }] });
            }

            initDashboard();

            // 语音评分模块
            const speechModule = document.getElementById('speech');
            if (speechModule) {
                const getSentenceBtn = speechModule.querySelector('.generate-sentence-btn');
                const sentenceDisplay = speechModule.querySelector('.sentence-box');
                const recordBtn = speechModule.querySelector('.rec-btn');
                const scoreDisplay = speechModule.querySelector('.score-display');
                const timerDisplay = speechModule.querySelector('.timer');
                const useSimpleScoringCheckbox = speechModule.querySelector('#useSimpleScoring');
                const useDetailedScoringCheckbox = speechModule.querySelector('#useDetailedScoring');

                let currentSentence = '';
                let audioBlob = null;
                let isSimpleScoring = useSimpleScoringCheckbox ? useSimpleScoringCheckbox.checked : true; // 默认使用简化模式
                let isDetailedScoring = useDetailedScoringCheckbox ? useDetailedScoringCheckbox.checked : false; // 默认不使用详细分析

                // 添加评分模式切换监听器
                if (useSimpleScoringCheckbox) {
                    useSimpleScoringCheckbox.addEventListener('change', function() {
                        isSimpleScoring = this.checked;
                        console.log(`简化评分模式: ${isSimpleScoring ? '开启' : '关闭'}`);
                        
                        if (isSimpleScoring) {
                            // 切换到简化模式时，重置评分显示
                            scoreDisplay.textContent = '0';
                            scoreDisplay.style.color = '#3A86FF';
                            document.querySelector('.score-rating').textContent = '未评分';
                            clearDetailedResults();
                        }
                    });
                }
                
                if (useDetailedScoringCheckbox) {
                    useDetailedScoringCheckbox.addEventListener('change', function() {
                        isDetailedScoring = this.checked;
                        console.log(`详细评分模式: ${isDetailedScoring ? '开启' : '关闭'}`);
                        
                        if (!isDetailedScoring) {
                            clearDetailedResults();
                        }
                    });
                }

                // 清理详细结果显示
                function clearDetailedResults() {
                    const detailedResultsContainer = document.getElementById('detailed-results');
                    if (detailedResultsContainer) {
                        detailedResultsContainer.remove();
                    }
                }

                // 显示详细评分结果
                function displayDetailedResults(result) {
                    // 清理之前的结果
                    clearDetailedResults();
                    
                    // 创建详细结果容器
                    const detailedContainer = document.createElement('div');
                    detailedContainer.id = 'detailed-results';
                    detailedContainer.style.cssText = `
                        margin-top: 24px; 
                        padding: 16px; 
                        background: #F8F9FA; 
                        border-radius: 8px; 
                        border: 1px solid #E9ECEF;
                        max-height: 500px;
                        overflow-y: auto;
                    `;
                    
                    let detailedHTML = `
                        <h4 style="margin-bottom: 16px; color: #495057; font-size: 1.1rem;">🔍 详细分析结果</h4>
                    `;
                    
                    // 显示单词级评分和建议（优先显示）
                    if (result.word_scores && result.word_scores.length > 0) {
                        // 筛选需要改进的单词
                        const wordsNeedingImprovement = result.word_scores.filter(ws => ws.needs_improvement);
                        
                        if (wordsNeedingImprovement.length > 0) {
                            detailedHTML += `
                                <div style="margin-bottom: 20px; padding: 12px; background: #FFF5F5; border-left: 4px solid #E63946; border-radius: 4px;">
                                    <h5 style="margin-bottom: 12px; color: #E63946; font-size: 1rem;">🎯 需要重点改进的单词:</h5>
                            `;
                            
                            wordsNeedingImprovement.forEach(wordInfo => {
                                const qualityColor = {
                                    'excellent': '#52B788',
                                    'good': '#3A86FF', 
                                    'fair': '#FFD166',
                                    'poor': '#E63946',
                                    'unknown': '#868E96'
                                }[wordInfo.quality] || '#868E96';
                                
                                const qualityText = {
                                    'excellent': '优秀',
                                    'good': '良好', 
                                    'fair': '一般',
                                    'poor': '较差',
                                    'unknown': '未知'
                                }[wordInfo.quality] || '未知';
                                
                                detailedHTML += `
                                    <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #E9ECEF;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <strong style="color: #495057; font-size: 1rem;">'${wordInfo.word}'</strong>
                                            <span style="
                                                padding: 3px 8px; 
                                                background: ${qualityColor}; 
                                                color: white; 
                                                border-radius: 12px; 
                                                font-size: 0.8rem;
                                                font-weight: 600;
                                            ">${wordInfo.score.toFixed(1)}分 (${qualityText})</span>
                                        </div>
                                `;
                                
                                // 显示该单词的具体建议
                                if (wordInfo.suggestions && wordInfo.suggestions.length > 0) {
                                    detailedHTML += `
                                        <div style="margin-left: 16px;">
                                            <p style="font-size: 0.9rem; color: #495057; margin-bottom: 4px; font-weight: 600;">💡 改进建议:</p>
                                            <ul style="margin-left: 16px; margin-bottom: 8px;">
                                    `;
                                    wordInfo.suggestions.forEach(suggestion => {
                                        detailedHTML += `<li style="color: #495057; font-size: 0.85rem; margin-bottom: 2px;">${suggestion}</li>`;
                                    });
                                    detailedHTML += `</ul>`;
                                }
                                
                                // 显示音素级详情（可展开）
                                if (wordInfo.phoneme_scores && wordInfo.phoneme_scores.length > 0) {
                                    detailedHTML += `
                                        <details style="margin-left: 16px;">
                                            <summary style="cursor: pointer; color: #3A86FF; font-size: 0.85rem;">📊 查看音素详情</summary>
                                            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                                    `;
                                    wordInfo.phoneme_scores.forEach(ps => {
                                        const phonemeColor = {
                                            'excellent': '#52B788',
                                            'good': '#3A86FF',
                                            'fair': '#FFD166',
                                            'poor': '#E63946'
                                        }[ps.quality] || '#868E96';
                                        
                                        detailedHTML += `
                                            <span style="
                                                display: inline-block;
                                                padding: 2px 6px;
                                                background: ${phonemeColor};
                                                color: white;
                                                border-radius: 3px;
                                                font-size: 0.75rem;
                                                margin: 1px;
                                            " title="评分: ${ps.score.toFixed(1)}">
                                                ${ps.phoneme} (${ps.score.toFixed(0)})
                                            </span>
                                        `;
                                    });
                                    detailedHTML += `
                                            </div>
                                        </details>
                                    `;
                                }
                                
                                detailedHTML += `</div>`;
                            });
                            
                            detailedHTML += `</div>`;
                        }
                        
                        // 显示表现良好的单词（鼓励）
                        const goodWords = result.word_scores.filter(ws => !ws.needs_improvement && ws.score > 0);
                        if (goodWords.length > 0) {
                            detailedHTML += `
                                <div style="margin-bottom: 16px; padding: 12px; background: #F0F8F0; border-left: 4px solid #52B788; border-radius: 4px;">
                                    <h5 style="margin-bottom: 8px; color: #52B788; font-size: 0.95rem;">🌟 发音良好的单词:</h5>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            `;
                            goodWords.forEach(wordInfo => {
                                detailedHTML += `
                                    <span style="
                                        padding: 4px 8px;
                                        background: #52B788;
                                        color: white;
                                        border-radius: 12px;
                                        font-size: 0.85rem;
                                        font-weight: 500;
                                    ">'${wordInfo.word}' (${wordInfo.score.toFixed(1)})</span>
                                `;
                            });
                            detailedHTML += `
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // 显示音素级评分（折叠显示，避免过于冗长）
                    if (result.phoneme_scores && result.phoneme_scores.length > 0) {
                        detailedHTML += `
                            <details style="margin-bottom: 16px;">
                                <summary style="cursor: pointer; color: #3A86FF; font-weight: 600; margin-bottom: 8px;">🔊 查看完整音素分析 (${result.phoneme_scores.length}个音素)</summary>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px; padding: 8px; background: white; border-radius: 4px;">
                        `;
                        
                        result.phoneme_scores.forEach(ps => {
                            let bgColor = '#52B788';  // 绿色（优秀）
                            if (ps.quality === 'good') bgColor = '#3A86FF';      // 蓝色（良好）
                            else if (ps.quality === 'fair') bgColor = '#FFD166';  // 黄色（一般）
                            else if (ps.quality === 'poor') bgColor = '#E63946';  // 红色（较差）
                            
                            detailedHTML += `
                                <span style="
                                    display: inline-block; 
                                    padding: 4px 8px; 
                                    margin: 2px; 
                                    background: ${bgColor};
                                    color: white; 
                                    border-radius: 4px; 
                                    font-size: 0.9rem;
                                    cursor: pointer;
                                " title="评分: ${ps.score.toFixed(1)}, 时间: ${ps.start_time.toFixed(2)}s-${ps.end_time.toFixed(2)}s">
                                    ${ps.phoneme} (${ps.score.toFixed(0)})
                                </span>
                            `;
                        });
                        
                        detailedHTML += `
                                </div>
                                <p style="font-size: 0.8rem; color: #868E96; margin-top: 8px;">
                                    颜色说明: <span style="color: #52B788;">█ 优秀</span> 
                                    <span style="color: #3A86FF;">█ 良好</span> 
                                    <span style="color: #FFD166;">█ 一般</span> 
                                    <span style="color: #E63946;">█ 需改进</span>
                                </p>
                            </details>
                        `;
                    }
                    
                    // 显示发现的问题（如果有）
                    if (result.pronunciation_issues && result.pronunciation_issues.length > 0) {
                        detailedHTML += `
                            <details style="margin-bottom: 16px;">
                                <summary style="cursor: pointer; color: #E63946; font-weight: 600;">⚠️ 发现的技术问题 (${result.pronunciation_issues.length}项)</summary>
                                <ul style="margin-left: 16px; color: #495057; margin-top: 8px;">
                        `;
                        result.pronunciation_issues.forEach(issue => {
                            detailedHTML += `<li style="margin-bottom: 4px; font-size: 0.9rem;">${issue}</li>`;
                        });
                        detailedHTML += `</ul></details>`;
                    }
                    
                    // 显示改进建议（重要，始终展开）
                    if (result.improvement_suggestions && result.improvement_suggestions.length > 0) {
                        detailedHTML += `
                            <div style="margin-bottom: 16px; padding: 12px; background: #F0F4FF; border-left: 4px solid #3A86FF; border-radius: 4px;">
                                <h5 style="margin-bottom: 8px; color: #3A86FF; font-weight: 600;">💡 综合改进建议:</h5>
                                <div style="color: #495057; line-height: 1.5;">
                        `;
                        result.improvement_suggestions.forEach(suggestion => {
                            // 检查是否是标题行（包含emoji或特殊字符）
                            if (suggestion.match(/^[\u{1F300}-\u{1F9FF}]|^\s*[\u2022\u2023\u25E6\u2043\u2219]/u) || 
                                suggestion.includes(':')) {
                                detailedHTML += `<p style="font-weight: 600; margin: 8px 0 4px 0; color: #3A86FF;">${suggestion}</p>`;
                            } else {
                                detailedHTML += `<p style="margin: 4px 0; padding-left: 12px;">${suggestion}</p>`;
                            }
                        });
                        detailedHTML += `</div></div>`;
                    }
                    
                    // 显示练习统计（如果有）
                    if (result.duration_analysis) {
                        detailedHTML += `
                            <details style="margin-bottom: 8px;">
                                <summary style="cursor: pointer; color: #868E96; font-size: 0.9rem;">📊 语音分析数据</summary>
                                <div style="font-size: 0.8rem; color: #495057; margin-top: 8px;">
                                    <p>总时长: ${result.duration_analysis.total_duration?.toFixed(2) || '未知'}秒</p>
                                    <p>语速: ${result.duration_analysis.speech_rate?.toFixed(1) || '未知'} 音素/秒</p>
                                    <p>平均音素时长: ${result.duration_analysis.avg_phoneme_duration?.toFixed(3) || '未知'}秒</p>
                                </div>
                            </details>
                        `;
                    }
                    
                    detailedContainer.innerHTML = detailedHTML;
                    
                    // 将详细结果添加到右侧面板
                    const dashboard = speechModule.querySelector('.dashboard');
                    if (dashboard) {
                        dashboard.appendChild(detailedContainer);
                    }
                }
                getSentenceBtn.addEventListener('click', async () => {
                    try {
                        const response = await axios.get('/api/random-english-sentence');
                        currentSentence = response.data.sentence;
                        sentenceDisplay.textContent = currentSentence;
                        scoreDisplay.textContent = '0';
                        scoreDisplay.style.color = '#3A86FF';
                        document.querySelector('.score-rating').textContent = '未评分';
                        updateScoreDashboard(0);
                    } catch (error) {
                        console.error('获取句子失败:', error);
                        alert('获取句子失败，请重试');
                    }
                });

                // 录音功能实现
                let mediaRecorder;
                let audioChunks = [];
                let recordingTimer;
                let seconds = 0;
                let minutes = 0;

                // 格式化时间显示
                function formatTime() {
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }

                // 更新计时器
                function updateTimer() {
                    seconds++;
                    if (seconds >= 60) {
                        seconds = 0;
                        minutes++;
                    }
                    timerDisplay.textContent = formatTime();
                }

                // 开始录音
                async function startRecording() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];

                        mediaRecorder.ondataavailable = event => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                            }
                        };

                        mediaRecorder.onstop = () => {
                            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            stream.getTracks().forEach(track => track.stop());
                            alert('录音完成');
                            initWaveform(); // 更新波形图
                        };

                        mediaRecorder.start();
                        seconds = 0;
                        minutes = 0;
                        timerDisplay.textContent = formatTime();
                        recordingTimer = setInterval(updateTimer, 1000);
                    } catch (error) {
                        console.error('录音权限请求失败:', error);
                        alert('无法访问麦克风。请确保已授予麦克风权限并尝试再次录音。');
                        recorder.classList.remove('recording');
                    }
                }

                // 停止录音
                function stopRecording() {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        clearInterval(recordingTimer);
                    }
                }

                // 录音按钮状态切换
                recordBtn.addEventListener('click', () => {
                    // 确保有句子才能录音
                    if (!currentSentence) {
                        alert('请先点击"生成新句子"按钮获取句子');
                        return;
                    }

                    const recorder = recordBtn.closest('.recorder');
                    recorder.classList.toggle('recording');

                    if (recorder.classList.contains('recording')) {
                        startRecording();
                    } else {
                        stopRecording();
                        timerDisplay.textContent = '00:00';
                    }
                });

                // 添加提交评分按钮事件
                const submitScoreBtn = document.createElement('button');
                submitScoreBtn.textContent = '提交评分';
                submitScoreBtn.style.cssText = 'background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px;';
                speechModule.querySelector('.panel').appendChild(submitScoreBtn);

                // 提交评分
                submitScoreBtn.addEventListener('click', async () => {
                    if (!currentSentence || !audioBlob) {
                        alert('请先获取句子并完成录音');
                        return;
                    }

                    try {
                        // 显示加载状态
                        submitScoreBtn.textContent = '评分中...';
                        submitScoreBtn.disabled = true;
                        
                        // 清理之前的详细结果
                        clearDetailedResults();
                        
                        // 检查用户选择的评分模式
                        const useSimpleScoring = useSimpleScoringCheckbox ? useSimpleScoringCheckbox.checked : true;
                        const useDetailedScoring = useDetailedScoringCheckbox ? useDetailedScoringCheckbox.checked : false;
                        
                        let apiEndpoint;
                        let modeText;
                        
                        if (useDetailedScoring) {
                            apiEndpoint = '/api/score-pronunciation-detailed';
                            modeText = '音素级详细模式';
                        } else if (useSimpleScoring) {
                            apiEndpoint = '/api/score-pronunciation-simple';
                            modeText = '简化模式';
                        } else {
                            apiEndpoint = '/api/score-pronunciation';
                            modeText = '完整模式';
                        }
                        
                        console.log(`使用${modeText}，接口: ${apiEndpoint}`);
                        
                        const formData = new FormData();
                        formData.append('reference_text', currentSentence);
                        formData.append('audio_file', audioBlob, 'recording.webm');

                        console.log('正在提交评分请求...');
                        const response = await axios.post(apiEndpoint, formData);
                        console.log('评分响应:', response.data);
                        
                        if (response.data.error) {
                            throw new Error(response.data.error);
                        }
                        
                        // 处理不同类型的评分结果
                        let score, detailedResult = null;
                        
                        if (useDetailedScoring && response.data.overall_score !== undefined) {
                            // 详细评分结果
                            score = response.data.overall_score;
                            detailedResult = response.data;
                        } else {
                            // 简单评分结果
                            score = response.data.score;
                        }
                        
                        // 更新评分显示
                        scoreDisplay.textContent = score;
                        updateScoreDashboard(score);
                        
                        // 更新评分等级
                        const scoreNum = parseFloat(score);
                        if (scoreNum >= 90) {
                            document.querySelector('.score-rating').textContent = '优秀';
                            scoreDisplay.style.color = '#52B788';
                        } else if (scoreNum >= 75) {
                            document.querySelector('.score-rating').textContent = '良好';
                            scoreDisplay.style.color = '#3A86FF';
                        } else if (scoreNum >= 60) {
                            document.querySelector('.score-rating').textContent = '及格';
                            scoreDisplay.style.color = '#FFD166';
                        } else {
                            document.querySelector('.score-rating').textContent = '需要改进';
                            scoreDisplay.style.color = '#E63946';
                        }
                        
                        // 显示详细结果（如果有）
                        if (detailedResult && detailedResult.detailed !== false) {
                            displayDetailedResults(detailedResult);
                            alert(`评分完成！您的得分是：${score}分\n（使用${modeText}）\n请查看下方的详细分析结果`);
                        } else {
                            // 显示成功消息
                            alert(`评分完成！您的得分是：${score}分\n（使用${modeText}）`);
                        }
                        
                    } catch (error) {
                        console.error('评分失败:', error);
                        
                        let errorMessage = '评分失败，请重试';
                        if (error.response && error.response.data && error.response.data.error) {
                            errorMessage = `评分失败：${error.response.data.error}`;
                        } else if (error.message) {
                            errorMessage = `评分失败：${error.message}`;
                        }
                        
                        alert(errorMessage);
                        
                        // 如果完整模式失败，建议用户切换到简化模式
                        if (!useSimpleScoringCheckbox.checked && !useDetailedScoringCheckbox.checked) {
                            if (confirm('完整评分模式失败，是否切换到简化模式重试？')) {
                                useSimpleScoringCheckbox.checked = true;
                                alert('已切换到简化模式，请重新点击"提交评分"按钮');
                            }
                        }
                        
                        // 重置评分显示
                        scoreDisplay.textContent = '0';
                        scoreDisplay.style.color = '#3A86FF';
                        document.querySelector('.score-rating').textContent = '评分失败';
                    } finally {
                        // 恢复按钮状态
                        submitScoreBtn.textContent = '提交评分';
                        submitScoreBtn.disabled = false;
                    }
                });
            }

            // 语法检测模块
            const grammarModule = document.getElementById('grammar');
            if (grammarModule) {
                const getChineseBtn = grammarModule.querySelector('.generate-sentence-btn');
                const chineseDisplay = grammarModule.querySelector('.sentence-box');
                const translatedInput = grammarModule.querySelector('textarea');
                const recordGrammarBtn = grammarModule.querySelector('.rec-btn');
                const errorTextDisplay = grammarModule.querySelector('.error-text');

                let currentChinese = '';
                let grammarMediaRecorder = null;
                let grammarChunks = [];
                let grammarAudioBlob = null;

                // 获取随机中文句子
                getChineseBtn.addEventListener('click', async () => {
                    try {
                        const response = await axios.get('/api/random-chinese-sentence');
                        currentChinese = response.data.sentence;
                        chineseDisplay.textContent = currentChinese;
                        translatedInput.value = '';
                        errorTextDisplay.innerHTML = '<p>请输入英文翻译（可选录音）...</p>';
                        grammarAudioBlob = null;
                    } catch (error) {
                        console.error('获取中文句子失败:', error);
                        alert('获取中文句子失败，请重试');
                    }
                });

                // 录音功能（可选）
                recordGrammarBtn.addEventListener('click', async () => {
                    if (!currentChinese) {
                        alert('请先获取中文句子');
                        return;
                    }

                    const container = recordGrammarBtn.closest('.panel');
                    container.classList.toggle('recording');

                    try {
                        if (container.classList.contains('recording')) {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            grammarChunks = [];
                            grammarMediaRecorder = new MediaRecorder(stream);
                            grammarMediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) grammarChunks.push(e.data); };
                            grammarMediaRecorder.onstop = () => {
                                grammarAudioBlob = new Blob(grammarChunks, { type: 'audio/webm' });
                                stream.getTracks().forEach(t => t.stop());
                                alert('录音完成');
                            };
                            grammarMediaRecorder.start();
                        } else {
                            if (grammarMediaRecorder && grammarMediaRecorder.state !== 'inactive') {
                                grammarMediaRecorder.stop();
                            }
                        }
                    } catch (err) {
                        console.error('录音失败:', err);
                        alert('无法访问麦克风');
                        container.classList.remove('recording');
                    }
                });

                // 添加提交语法检测按钮
                const submitGrammarBtn = document.createElement('button');
                submitGrammarBtn.textContent = '提交检测';
                submitGrammarBtn.style.cssText = 'background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px;';
                grammarModule.querySelector('.panel').appendChild(submitGrammarBtn);

                // 提交语法检测（音频可选）
                submitGrammarBtn.addEventListener('click', async () => {
                    if (!currentChinese || !translatedInput.value.trim()) {
                        alert('请先获取中文句子并输入英文翻译');
                        return;
                    }

                    try {
                        const formData = new FormData();
                        formData.append('translated_text', translatedInput.value.trim());
                        if (grammarAudioBlob) {
                            formData.append('audio_file', grammarAudioBlob, 'grammar_recording.webm');
                        }

                        const response = await axios.post('/api/check-grammar', formData);
                        const result = response.data.result;
                        if (result.status === 'success') {
                            errorTextDisplay.innerHTML = '<span class="text-green-600">✅ 英文语法正确!</span>';
                        } else {
                            let errorHtml = `<div class="text-red-600">❌ 检测到 ${result.error_count} 处语法问题:</div>`;
                            result.errors.forEach((error, index) => {
                                errorHtml += `
<div class="mt-2 p-2 bg-red-50 rounded">
  <div><strong>【错误 ${index + 1}】</strong></div>
  <div>📌 规则ID: ${error.rule_id}</div>
  <div>❗ 问题描述: ${error.message}</div>
  <div>🔍 上下文: ${error.context}</div>
  <div>💡 建议替换: ${error.replacements.join(', ')}</div>
</div>`;
                            });
                            errorTextDisplay.innerHTML = errorHtml;
                        }
                    } catch (error) {
                        console.error('语法检测失败:', error);
                        alert('语法检测失败，请重试');
                    }
                });
            }

            // 文件上传效果
            const uploadArea = document.querySelector('.upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#3A86FF';
                    uploadArea.style.backgroundColor = '#F1F8FF';
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.style.borderColor = '#DEE2E6';
                    uploadArea.style.backgroundColor = 'white';
                });
            }

            // 自定义练习模块 - 模式切换功能
            const customModule = document.getElementById('custom');
            if (customModule) {
                const modeBtns = customModule.querySelectorAll('.mode-btn');
                const audioUploadArea = customModule.querySelector('.upload-area');
                const fileList = customModule.querySelector('.upload-area + div');
                
                // 创建文本练习区域
                const textExerciseArea = document.createElement('div');
                textExerciseArea.style.display = 'none';
                textExerciseArea.innerHTML = `
                    <textarea rows="8" style="width: 100%; padding: 16px; border: 1px solid #DEE2E6; border-radius: 6px; font-size: 1rem; margin-bottom: 16px;" placeholder="在此输入或粘贴您的文本练习材料..."></textarea>
                    <button style="background: #3A86FF; color: white; padding: 10px 24px; border-radius: 6px; border: none; cursor: pointer;">导入文本</button>
                `;
                
                // 将文本练习区域插入到DOM中
                audioUploadArea.parentNode.insertBefore(textExerciseArea, audioUploadArea.nextSibling);
                
                // 为模式按钮添加点击事件
                modeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // 移除所有按钮的active状态
                        modeBtns.forEach(b => b.classList.remove('active'));
                        // 为当前点击的按钮添加active状态
                        btn.classList.add('active');
                        
                        // 根据选择的模式显示相应的区域
                        if (btn.textContent.trim() === '音频练习') {
                            audioUploadArea.style.display = 'flex';
                            fileList.style.display = 'block';
                            textExerciseArea.style.display = 'none';
                        } else if (btn.textContent.trim() === '文本练习') {
                            audioUploadArea.style.display = 'none';
                            fileList.style.display = 'none';
                            textExerciseArea.style.display = 'block';
                        }
                    });
                });
            }

            // 自定义练习模块 - 开始练习和提交答案按钮（通过文本匹配选择）
            let startPracticeBtn = null;
            let submitAnswerBtn = null;
            document.querySelectorAll('.module#custom button').forEach(btn => {
                const text = btn.textContent.trim();
                if (text === '开始练习') startPracticeBtn = btn;
                if (text === '提交答案') submitAnswerBtn = btn;
            });
            const customExerciseContent = document.querySelector('.module#custom .sentence-box');
            let currentExerciseData = null;
            let currentMode = 'audio'; // 默认音频模式
            let customMediaRecorder = null;
            let customChunks = [];
            let customAudioBlob = null;
            
            // 跟踪当前选择的模式
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.textContent.trim() === '音频练习') {
                        currentMode = 'audio';
                    } else if (btn.textContent.trim() === '文本练习') {
                        currentMode = 'text';
                    }
                });
            });
            
            if (startPracticeBtn) {
                startPracticeBtn.addEventListener('click', async () => {
                    try {
                        const mode = currentMode === 'audio' ? 'speech' : 'grammar';
                        const response = await axios.post('/api/custom-exercise', { mode });
                        currentExerciseData = response.data;
                        customAudioBlob = null;

                        if (response.data.reference_text) {
                            customExerciseContent.innerHTML = `
                                <p style="font-size: 1.2rem; margin-bottom: 16px;">请朗读以下内容：</p>
                                <p id="custom-ref" style="font-size: 1.5rem; font-weight: 500; color: #212529;">${response.data.reference_text}</p>
                            `;

                            // 音频模式：开始录音
                            try {
                                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                                customChunks = [];
                                customMediaRecorder = new MediaRecorder(stream);
                                customMediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) customChunks.push(e.data); };
                                customMediaRecorder.onstop = () => {
                                    customAudioBlob = new Blob(customChunks, { type: 'audio/webm' });
                                    stream.getTracks().forEach(t => t.stop());
                                };
                                customMediaRecorder.start();
                            } catch (e) {
                                console.error('自定义练习录音失败:', e);
                                alert('无法访问麦克风');
                            }
                        } else if (response.data.chinese_sentence) {
                            customExerciseContent.innerHTML = `
                                <p style="font-size: 1.2rem; margin-bottom: 16px;">请翻译以下中文：</p>
                                <p style="font-size: 1.5rem; font-weight: 500; color: #212529;">${response.data.chinese_sentence}</p>
                            `;
                        }
                    } catch (error) {
                        console.error('获取练习数据失败:', error);
                        alert('获取练习数据失败，请重试');
                    }
                });
            }
            
            if (submitAnswerBtn) {
                submitAnswerBtn.addEventListener('click', async () => {
                    if (!currentExerciseData) {
                        alert('请先点击"开始练习"按钮');
                        return;
                    }

                    if (currentMode === 'audio') {
                        // 停止录音并提交评分
                        try {
                            if (customMediaRecorder && customMediaRecorder.state !== 'inactive') {
                                await new Promise(resolve => {
                                    customMediaRecorder.onstop = () => { 
                                        customAudioBlob = new Blob(customChunks, { type: 'audio/webm' });
                                        resolve();
                                    };
                                    customMediaRecorder.stop();
                                });
                            }
                        } catch (e) { /* 忽略 */ }

                        if (!customAudioBlob) {
                            alert('未捕获到音频，请重试');
                            return;
                        }

                        try {
                            const refEl = document.getElementById('custom-ref');
                            const referenceText = refEl ? refEl.textContent : (currentExerciseData.reference_text || '');
                            const fd = new FormData();
                            fd.append('reference_text', referenceText);
                            fd.append('audio_file', customAudioBlob, 'custom_recording.webm');
                            const resp = await axios.post('/api/score-pronunciation', fd);
                            const score = resp.data.score || '0';
                            customExerciseContent.innerHTML += `
                                <div style="margin-top: 24px; padding: 16px; background: #F8F9FA; border-radius: 6px;">
                                    <p style="font-size: 1.2rem; font-weight: 600; color: #3A86FF;">练习完成！</p>
                                    <p style="font-size: 2rem; font-weight: 800; color: #3A86FF; margin-top: 12px;">${score}</p>
                                </div>
                            `;
                        } catch (err) {
                            console.error('提交评分失败:', err);
                            alert('提交评分失败，请重试');
                        }
                    } else {
                        // 文本练习：提交语法检测
                        const textarea = document.querySelector('.module#custom textarea');
                        const translatedText = textarea ? textarea.value.trim() : '';
                        if (!translatedText) {
                            alert('请输入您的翻译内容');
                            return;
                        }
                        try {
                            const fd = new FormData();
                            fd.append('translated_text', translatedText);
                            const resp = await axios.post('/api/check-grammar', fd);
                            const result = resp.data.result;
                            let html = `<div style="margin-top: 24px; padding: 16px; background: #F8F9FA; border-radius: 6px;">`;
                            if (result.status === 'success') {
                                html += `<span style="color:#52B788">✅ 语法正确！</span>`;
                            } else {
                                html += `<div style="color:#E63946">❌ 检测到 ${result.error_count} 处语法问题：</div>`;
                                result.errors.forEach((e, i) => {
                                    html += `<div class="mt-2 p-2 bg-red-50 rounded">【错误 ${i+1}】 ${e.message}</div>`;
                                });
                            }
                            html += `</div>`;
                            customExerciseContent.innerHTML += html;
                        } catch (err) {
                            console.error('提交语法检测失败:', err);
                            alert('提交语法检测失败，请重试');
                        }
                    }
                });
            }
            
            // 导入文本按钮事件 - 使用标准JavaScript方法查找包含特定文本的按钮
            const buttons = document.querySelectorAll('.module#custom button');
            let importTextBtn = null;
            buttons.forEach(button => {
                if (button.textContent.includes('导入文本')) {
                    importTextBtn = button;
                }
            });
            
            if (importTextBtn) {
                importTextBtn.addEventListener('click', () => {
                    const textarea = document.querySelector('.module#custom textarea');
                    if (textarea && textarea.value.trim()) {
                        alert('文本导入成功！点击"开始练习"开始您的自定义练习。');
                    } else {
                        alert('请先在文本框中输入内容');
                    }
                });
            }
        });
    </script>

</body></html>